<!-- Botón flotante para abrir el chat -->
@if (!isOpen()) {
  <button class="chat-toggle-btn" (click)="toggleChat()" [title]="'Abrir ' + chatTitle()">
    <i class="pi pi-comment"></i>
  </button>
}

<!-- Ventana de chat flotante -->
@if (isOpen()) {
  <div class="chat-window">
    <div class="chat-header">
      <div class="chat-header-content">
        <i class="pi pi-comment"></i>
        <h3>{{ chatTitle() }}</h3>
      </div>
      <div class="chat-header-actions">
        @if (messages().length > 0) {
          <button class="btn-icon" (click)="clearHistory()" title="Limpiar historial">
            <i class="pi pi-trash"></i>
          </button>
        }
        <button class="btn-icon" (click)="toggleChat()" title="Cerrar chat">
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>

    <div class="chat-messages" #messagesContainer>
      @if (messages().length === 0) {
        <div class="chat-welcome">
          <div class="welcome-icon">
            <i class="pi pi-bolt"></i>
          </div>
          <h4>¡Hola! Soy tu asistente IA</h4>
          <p>Puedo ayudarte con cualquier pregunta sobre la sección actual o tus datos.</p>
          <div class="suggestion-chips">
            <button class="chip" (click)="askSuggestion('¿Qué proveedor me factura más?')">
              ¿Qué proveedor me factura más?
            </button>
            <button class="chip" (click)="askSuggestion('¿Cuánto IVA he pagado este año?')">
              ¿Cuánto IVA he pagado?
            </button>
            <button class="chip" (click)="askSuggestion('Dame un resumen de mis facturas')">
              Resumen de facturas
            </button>
            <button class="chip" (click)="askSuggestion('¿Cuál es mi gasto mensual promedio?')">
              Gasto mensual promedio
            </button>
          </div>
        </div>
      }
      
      @for (message of messages(); track $index) {
        <div class="message" [class.user-message]="message.role === 'user'" [class.assistant-message]="message.role === 'assistant'">
          <div class="message-avatar">
            @if (message.role === 'user') {
              <i class="pi pi-user"></i>
            } @else {
              <i class="pi pi-bolt"></i>
            }
          </div>
          <div class="message-content">
            <div class="message-text">{{ message.content }}</div>
            <div class="message-time">{{ message.timestamp | date:'HH:mm' }}</div>
          </div>
        </div>
      }
      
      @if (isLoading()) {
        <div class="message assistant-message">
          <div class="message-avatar">
            <i class="pi pi-bolt"></i>
          </div>
          <div class="message-content">
            <div class="message-text typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
      }
    </div>

    <div class="chat-input-container">
      <input
        #messageInput
        type="text"
        class="chat-input"
        [ngModel]="currentMessage()"
        (ngModelChange)="currentMessage.set($event)"
        (keydown)="onKeyPress($event)"
        placeholder="Escribe tu pregunta aquí..."
        [disabled]="isLoading()"
      />
      <button
        class="chat-send-btn"
        (click)="sendMessage()"
        [disabled]="isLoading() || !currentMessage().trim()"
        title="Enviar mensaje"
      >
        @if (isLoading()) {
          <i class="pi pi-spin pi-spinner"></i>
        } @else {
          <i class="pi pi-send"></i>
        }
      </button>
    </div>
  </div>
}

