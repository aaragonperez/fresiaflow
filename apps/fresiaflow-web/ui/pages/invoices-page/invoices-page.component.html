<div class="invoices-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <i class="pi pi-file-pdf"></i>
        Facturas Recibidas
      </h1>
      <p class="subtitle">Gestión contable de facturas recibidas de proveedores</p>
    </div>
  </div>

  <!-- Estadísticas Contables - Compactas -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="pi pi-file"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ invoices().length }}</div>
        <div class="stat-label">Total Facturas</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon bank">
        <i class="pi pi-credit-card"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ bankInvoices().length }}</div>
        <div class="stat-label">Pago Banco</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon cash">
        <i class="pi pi-money-bill"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ cashInvoices().length }}</div>
        <div class="stat-label">Pago Efectivo</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon warning">
        <i class="pi pi-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ lowConfidenceInvoices().length }}</div>
        <div class="stat-label">Baja Confianza</div>
      </div>
    </div>

    <div class="stat-card financial">
      <div class="stat-icon financial-icon">
        <i class="pi pi-euro"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalAmount() | number:'1.2-2' }} <span class="currency">€</span></div>
        <div class="stat-label">Total Facturado</div>
      </div>
    </div>

    <div class="stat-card financial">
      <div class="stat-icon tax-icon">
        <i class="pi pi-percentage"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalTaxAmount() | number:'1.2-2' }} <span class="currency">€</span></div>
        <div class="stat-label">Total IVA</div>
      </div>
    </div>

    <div class="stat-card financial">
      <div class="stat-icon base-icon">
        <i class="pi pi-calculator"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalSubtotalAmount() | number:'1.2-2' }} <span class="currency">€</span></div>
        <div class="stat-label">Base Imponible</div>
      </div>
    </div>
  </div>

  <!-- Filtros Contables - Colapsable -->
  <div class="collapsible-section" [class.collapsed]="filtersCollapsed()">
    <div class="section-header" (click)="filtersCollapsed.set(!filtersCollapsed())">
      <div class="section-title">
        <i class="pi pi-filter"></i>
        <h3>Filtros Contables</h3>
        <span class="active-filters-badge" *ngIf="filterYear() || filterQuarter() || filterSupplier() || filterPaymentType()">
          Filtros activos
        </span>
      </div>
      <div class="section-actions">
        <button class="btn-clear-filters" (click)="clearFilters(); $event.stopPropagation()" 
                [disabled]="!filterYear() && !filterQuarter() && !filterSupplier() && !filterPaymentType()">
          <i class="pi pi-times"></i> Limpiar
        </button>
        <i class="collapse-icon pi" [class.pi-chevron-down]="filtersCollapsed()" [class.pi-chevron-up]="!filtersCollapsed()"></i>
      </div>
    </div>
    <div class="section-content" [class.hidden]="filtersCollapsed()">
      <div class="filters-grid">
        <div class="filter-group">
          <label><i class="pi pi-calendar"></i> Año Fiscal</label>
          <select [ngModel]="filterYear()" (ngModelChange)="onYearChange($event)">
            <option [ngValue]="null">Todos los años</option>
            @for (year of availableYears; track year) {
              <option [ngValue]="year">{{ year }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label><i class="pi pi-calendar-times"></i> Trimestre</label>
          <select [ngModel]="filterQuarter()" (ngModelChange)="onQuarterChange($event)">
            <option [ngValue]="null">Todos</option>
            @for (q of quarters; track q) {
              <option [ngValue]="q">Q{{ q }}</option>
            }
          </select>
        </div>

        <div class="filter-group">
          <label><i class="pi pi-building"></i> Proveedor</label>
          <input 
            type="text" 
            [ngModel]="filterSupplier()" 
            (ngModelChange)="filterSupplier.set($event)"
            (keyup.enter)="loadInvoices()"
            (blur)="loadInvoices()"
            placeholder="Buscar por nombre..."
          />
        </div>

        <div class="filter-group">
          <label><i class="pi pi-credit-card"></i> Tipo de Pago</label>
          <select [ngModel]="filterPaymentType()" (ngModelChange)="onPaymentTypeChange($event)">
            <option [ngValue]="null">Todos</option>
            <option [ngValue]="'Bank'">Banco</option>
            <option [ngValue]="'Cash'">Efectivo</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat IA -->
  @if (loading()) {
    <div class="loading-state">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem; color: #dc2626;"></i>
      <p>Cargando facturas...</p>
    </div>
  }

  @if (error()) {
    <div class="error-message">
      <i class="pi pi-exclamation-triangle"></i>
      {{ error() }}
    </div>
  }

  <!-- Área de carga de archivos - Colapsable -->
  <div class="collapsible-section" [class.collapsed]="uploadCollapsed()">
    <div class="section-header" (click)="uploadCollapsed.set(!uploadCollapsed())">
      <div class="section-title">
        <i class="pi pi-cloud-upload"></i>
        <h3>Subir Facturas</h3>
      </div>
      <div class="section-actions">
        <i class="collapse-icon pi" [class.pi-chevron-down]="uploadCollapsed()" [class.pi-chevron-up]="!uploadCollapsed()"></i>
      </div>
    </div>
    <div class="section-content" [class.hidden]="uploadCollapsed()">
      <div 
        class="upload-area" 
        [class.drag-over]="isDragging"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
      >
        <input
          type="file"
          accept=".pdf,.jpg,.jpeg,.png,.gif,.webp"
          (change)="onFileSelected($event)"
          #fileInput
          id="fileInput"
          multiple
          style="display: none;"
        />
        <label for="fileInput" class="file-upload-label">
          <i class="pi pi-cloud-upload"></i>
          <div class="upload-text">
            <strong>Haz clic para subir</strong> o arrastra aquí
          </div>
          <div class="upload-hint">PDF o imágenes (JPG, PNG, GIF, WEBP) - Múltiples archivos</div>
        </label>
      </div>
    </div>
  </div>

  <!-- Tabla de facturas - Colapsable -->
  @if (!loading() && invoices().length > 0) {
    <div class="collapsible-section" [class.collapsed]="tableCollapsed()">
      <div class="section-header" (click)="tableCollapsed.set(!tableCollapsed())">
        <div class="section-title">
          <i class="pi pi-list"></i>
          <h3>Listado de Facturas</h3>
          <span class="count-badge">{{ invoices().length }}</span>
        </div>
        <div class="section-actions">
          <button class="btn-export" (click)="exportToExcel(); $event.stopPropagation()" [disabled]="loading()">
            <i class="pi pi-file-excel"></i>
            Exportar Excel
          </button>
          <i class="collapse-icon pi" [class.pi-chevron-down]="tableCollapsed()" [class.pi-chevron-up]="!tableCollapsed()"></i>
        </div>
      </div>
      <div class="section-content" [class.hidden]="tableCollapsed()">
        <app-invoice-table 
          [invoices]="invoices()"
          (viewInvoice)="onViewInvoice($event)"
          (deleteInvoice)="onDeleteInvoice($event)"
          (editInvoice)="onEditInvoice($event)"
        />
      </div>
    </div>
  }

  @if (!loading() && invoices().length === 0) {
    <div class="empty-state">
      <i class="pi pi-inbox"></i>
      <h3>No hay facturas que mostrar</h3>
      <p class="empty-hint">Sube tu primera factura usando el área de carga de arriba</p>
    </div>
  }

  <!-- Diálogo de edición -->
  <app-invoice-edit-dialog
    [invoice]="editingInvoice()"
    [(visible)]="editDialogVisible"
    (save)="onSaveInvoice($event)"
  />
</div>
