{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=fresiaflow;Username=postgres;Password=Fresia_31"
  },
  "OpenAI": {
    "ApiKey": "sk-proj-YOUR-API-KEY-HERE",
    "Model": "gpt-4o-mini",
    "FallbackModel": "gpt-4o"
  },
  "ChatAI": {
    "OpenAI": {
      "ApiKey": "sk-proj-YOUR-API-KEY-HERE",
      "Model": "gpt-4o"
    },
    "InternetAccess": {
      "Enabled": true,
      "ProxyUrl": "",
      "ProxyUsername": "",
      "ProxyPassword": "",
      "Timeout": 30
    },
    "WebSearch": {
      "Provider": "DuckDuckGo",
      "ApiKey": ""
    }
  },
  "Banking": {
    "Provider": "TrueLayer",
    "ApiKey": "your-banking-api-key-here",
    "BaseUrl": "https://api.truelayer.com"
  },
  "Storage": {
    "BasePath": "./uploads"
  },
  "IncomingInvoices": {
    "WatchFolder": "./incoming-invoices",
    "ProcessedSuccessFolder": "./processed/success",
    "ProcessedErrorFolder": "./processed/error",
    "ScanIntervalSeconds": 60
  },
  "InvoiceExtraction": {
    "Prompts": {
      "SystemMessage": "Eres un asistente experto en extracci√≥n de datos de facturas. Respondes √∫nicamente con JSON v√°lido.",
      "OwnCompanyNames": [
        "FRESIA SOFTWARE SOLUTIONS",
        "Fresia Software Solutions",
        "Fresia Software",
        "FRESIA SOFTWARE SOLUTIONS SL",
        "FRESIA SOFTWARE SOLUTIONS S.L."
      ],
      "BasicExtractionTemplate": "Extrae los siguientes datos de la factura y devu√©lvelos en formato JSON estricto:\n\n{\n  \"InvoiceNumber\": \"string\",\n  \"IssueDate\": \"YYYY-MM-DD\",\n  \"DueDate\": \"YYYY-MM-DD\" o null,\n  \"Amount\": n√∫mero decimal (sin s√≠mbolos de moneda),\n  \"SupplierName\": \"string\",\n  \"Confidence\": n√∫mero decimal entre 0 y 1\n}\n\nIMPORTANTE:\n- InvoiceNumber: n√∫mero de factura como string\n- IssueDate: fecha en formato ISO (YYYY-MM-DD)\n- DueDate: fecha en formato ISO (YYYY-MM-DD) o null si no existe\n- Amount: solo el n√∫mero decimal, sin s√≠mbolos de moneda ni espacios (ej: 43.19, no \"43,19 ‚Ç¨\")\n- SupplierName: nombre del proveedor (NUNCA puede ser FRESIA SOFTWARE SOLUTIONS)\n- Confidence: nivel de confianza de la extracci√≥n (0.0 a 1.0)\n\nFACTURA:\n{0}",
      "CompleteExtractionTemplate": "Eres un asistente experto en an√°lisis de facturas espa√±olas. Extrae la informaci√≥n de esta factura en formato JSON.\n\nFACTURA:\n{0}\n\n‚ö†Ô∏è REGLA CR√çTICA - EMPRESAS PROPIAS (NUNCA SON PROVEEDORES):\nLas siguientes empresas son NUESTRAS y NUNCA pueden ser el proveedor:\n{1}\n\nSi ves 'FRESIA SOFTWARE SOLUTIONS' en cualquier parte de la factura, esa es NUESTRA empresa (el CLIENTE/destinatario), NO el proveedor.\n\nüîç C√ìMO IDENTIFICAR AL PROVEEDOR CORRECTAMENTE:\n\n1. BUSCA EL LOGO: El proveedor casi siempre tiene su LOGO visible (puede estar en esquinas, laterales, o cabecera)\n\n2. TEXTO EN LATERALES: Algunas facturas tienen datos del proveedor en texto VERTICAL en los laterales (izquierdo o derecho). Lee ese texto rotado.\n\n3. EL PROVEEDOR ES QUIEN EMITE:\n   - Aparece junto al logo de la empresa\n   - Est√° en la secci√≥n 'EMISOR', 'DE:', 'FROM:', 'Datos del emisor'\n   - Su CIF/NIF aparece como 'CIF emisor' o similar\n   - Es quien vende/presta el servicio\n   - En facturas de AUT√ìNOMOS/PERSONAS F√çSICAS, el proveedor puede aparecer como:\n     * 'D¬™ [NOMBRE]' o 'D. [NOMBRE]' (ej: 'D¬™ ROMANA S√ÅNCHEZ GIJ√ìN')\n     * Nombre completo de persona f√≠sica\n     * Con NIF (8 d√≠gitos + letra) en lugar de CIF\n\n4. EL CLIENTE (NO es el proveedor):\n   - Aparece en recuadros tipo 'DATOS DEL CLIENTE', 'FACTURAR A:', 'BILL TO:', 'EMPRESA'\n   - FRESIA SOFTWARE SOLUTIONS siempre es el cliente, NUNCA el proveedor\n   - El CIF B87392700 pertenece a Fresia (cliente)\n\n5. EJEMPLO VISUAL:\n   [LOGO IDiCe] ‚Üê ESTO ES EL PROVEEDOR\n   IDiCe Strategy & Technology ‚Üê supplierName\n   \n   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n   ‚îÇ FRESIA SOFTWARE SOLUTIONS‚îÇ ‚Üê ESTO ES EL CLIENTE (NO el proveedor)\n   ‚îÇ C/ Angel de Saavedra... ‚îÇ\n   ‚îÇ CIF: B87392700          ‚îÇ\n   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\nüìã EXTRACCI√ìN DEL CIF/NIF DEL PROVEEDOR (supplierTaxId) - MUY IMPORTANTE:\n\nEl CIF/NIF del proveedor es CR√çTICO para identificar correctamente al proveedor. Sigue estos pasos:\n\n1. UBICACIONES DONDE BUSCAR EL CIF/NIF DEL PROVEEDOR:\n   - Junto al nombre del proveedor en la secci√≥n de emisor\n   - En campos etiquetados como: 'CIF', 'NIF', 'CIF/NIF', 'NIF/CIF', 'C.I.F.', 'N.I.F.', 'Tax ID', 'ID Fiscal'\n   - En la cabecera de la factura, cerca del logo del proveedor\n   - En el pie de p√°gina del proveedor (NO del cliente)\n   - En tablas de datos del emisor/proveedor\n   - En facturas de aut√≥nomos, busca 'NIF' junto al nombre de la persona\n\n2. FORMATOS COMUNES DE CIF/NIF EN ESPA√ëA:\n   - CIF (empresas): Letra + 8 d√≠gitos (ej: B12345678, A87654321, G12345678)\n   - NIF (personas f√≠sicas/aut√≥nomos): 8 d√≠gitos + letra (ej: 12345678A, 87654321B, 05874679L)\n   - Puede tener guiones o espacios: 'B-12345678', 'B 12345678', 'B12345678', '05874679 L'\n   - Puede tener puntos: 'B.12345678'\n\n3. C√ìMO IDENTIFICAR EL CIF CORRECTO:\n   - El CIF/NIF del PROVEEDOR est√° en la secci√≥n del EMISOR/VENDEDOR\n   - El CIF del CLIENTE est√° en la secci√≥n 'FACTURAR A' o 'DATOS DEL CLIENTE' o 'EMPRESA'\n   - NUNCA uses el CIF B87392700 (es de Fresia, el cliente)\n   - Si ves dos CIFs/NIFs, el del PROVEEDOR es el que est√° junto a su nombre/logo\n   - Busca texto como 'CIF emisor', 'CIF proveedor', 'NIF emisor', 'NIF'\n   - En facturas de aut√≥nomos, el NIF est√° junto al nombre de la persona (ej: 'D¬™ ROMANA S√ÅNCHEZ GIJ√ìN' con NIF '05874679L')\n\n4. NORMALIZACI√ìN:\n   - Extrae el CIF/NIF SIN espacios, guiones ni puntos\n   - Ejemplo: 'B-12345678' ‚Üí 'B12345678'\n   - Ejemplo: 'B 12345678' ‚Üí 'B12345678'\n   - Ejemplo: 'B.123.456.78' ‚Üí 'B12345678'\n   - Ejemplo: '05874679 L' ‚Üí '05874679L'\n   - Ejemplo: '05874679L' ‚Üí '05874679L' (ya normalizado)\n   - Mant√©n la letra inicial y los d√≠gitos\n   - Si el CIF tiene formato incorrecto pero es claramente un CIF/NIF, normal√≠zalo\n\n5. VALIDACI√ìN:\n   - El CIF/NIF debe tener entre 9 y 10 caracteres (letra + 8-9 d√≠gitos o 8-9 d√≠gitos + letra)\n   - Si encuentras un CIF que parece v√°lido pero tiene formato extra√±o, normal√≠zalo\n   - Si NO encuentras el CIF del proveedor, devuelve null (no inventes uno)\n   - Si solo encuentras el CIF del cliente (B87392700), devuelve null para supplierTaxId\n\n6. CASOS ESPECIALES:\n   - Si el CIF est√° parcialmente oculto o borroso, intenta leerlo lo mejor posible\n   - Si hay m√∫ltiples CIFs, elige el que est√° asociado al nombre del proveedor\n   - En facturas de aut√≥nomos, busca 'NIF' en lugar de 'CIF'\n   - Algunas facturas usan 'DNI' para personas f√≠sicas (normal√≠zalo como NIF)\n   - Facturas de aut√≥nomos suelen tener formato: 'D¬™ [NOMBRE]' o 'D. [NOMBRE]' con NIF\n\nüìÖ EXTRACCI√ìN DE FECHAS - MUY IMPORTANTE:\n\nLas fechas pueden aparecer en varios formatos en facturas espa√±olas:\n\n1. FORMATOS COMUNES:\n   - Espa√±ol completo: '1 DE SEPTIEMBRE DE 2022', '15 DE ENERO DE 2024'\n   - Espa√±ol corto: '01/09/2022', '15/01/2024'\n   - ISO: '2022-09-01', '2024-01-15'\n   - Con texto: 'Fecha: 1 DE SEPTIEMBRE DE 2022'\n\n2. CONVERSI√ìN OBLIGATORIA:\n   - SIEMPRE convierte las fechas a formato ISO (YYYY-MM-DD)\n   - Ejemplo: '1 DE SEPTIEMBRE DE 2022' ‚Üí '2022-09-01'\n   - Ejemplo: '15 DE ENERO DE 2024' ‚Üí '2024-01-15'\n   - Ejemplo: '01/09/2022' ‚Üí '2022-09-01'\n   - Ejemplo: '15/01/2024' ‚Üí '2024-01-15'\n\n3. MESES EN ESPA√ëOL:\n   - ENERO = 01, FEBRERO = 02, MARZO = 03, ABRIL = 04, MAYO = 05, JUNIO = 06\n   - JULIO = 07, AGOSTO = 08, SEPTIEMBRE = 09, OCTUBRE = 10, NOVIEMBRE = 11, DICIEMBRE = 12\n\n4. BUSCAR FECHAS EN:\n   - Campo 'FECHA' o 'Fecha'\n   - Cerca del n√∫mero de factura\n   - En la cabecera de la factura\n   - Formato: 'FECHA: 1 DE SEPTIEMBRE DE 2022'\n\nüî¢ EXTRACCI√ìN DEL N√öMERO DE FACTURA:\n\nEl n√∫mero de factura puede aparecer en varios formatos:\n\n1. FORMATOS COMUNES:\n   - 'N¬∫ DE FACTURA: 12/2022'\n   - 'N¬∫ FACTURA: 12/2022'\n   - 'FACTURA N¬∫: 12/2022'\n   - 'N√∫mero: 12/2022'\n   - '12/2022' (solo el n√∫mero)\n   - 'FAC-2022-0012'\n   - '2022/12'\n\n2. EXTRACCI√ìN:\n   - Extrae el n√∫mero COMPLETO tal como aparece (incluyendo formato)\n   - Ejemplo: '12/2022' ‚Üí '12/2022'\n   - Ejemplo: 'FAC-2022-0012' ‚Üí 'FAC-2022-0012'\n   - No modifiques el formato del n√∫mero de factura\n\nüí∞ EXTRACCI√ìN DE IMPORTES Y RETENCIONES:\n\n1. IVA (Impuesto sobre el Valor A√±adido):\n   - Busca 'I.V.A.', 'IVA', 'VAT'\n   - Ejemplo: 'I.V.A. 21%' con importe '168,00'\n   - Convierte comas a puntos: '168,00' ‚Üí 168.00\n   - Extrae el porcentaje: '21%' ‚Üí 21\n\n2. IRPF (Impuesto sobre la Renta de las Personas F√≠sicas - RETENCI√ìN):\n   - Busca 'IRPF', 'I.R.P.F.', 'Retenci√≥n IRPF'\n   - Ejemplo: 'IRPF 19%' con importe '152,00'\n   - IMPORTANTE: El IRPF es una RETENCI√ìN que se RESTA del total\n   - Convierte comas a puntos: '152,00' ‚Üí 152.00\n   - Extrae el porcentaje: '19%' ‚Üí 19\n   - Es com√∫n en facturas de aut√≥nomos/profesionales\n\n3. IMPORTES:\n   - Busca 'HONORARIOS EUROS', 'IMPORTE', 'TOTAL', 'LIQUIDO A INGRESAR'\n   - Convierte comas a puntos: '800,00' ‚Üí 800.00\n   - 'LIQUIDO A INGRESAR' o 'TOTAL A PAGAR' es el totalAmount (despu√©s de restar IRPF)\n   - La base imponible (subtotalAmount) es antes de IVA e IRPF\n\n4. C√ÅLCULOS:\n   - totalAmount = subtotalAmount + taxAmount - irpfAmount\n   - Si no viene subtotalAmount, calcular: subtotalAmount = totalAmount - taxAmount + irpfAmount\n\nDevuelve √öNICAMENTE este JSON (sin markdown ni texto adicional):\n{\n  \"invoiceNumber\": \"string (formato original, ej: '12/2022')\",\n  \"supplierName\": \"string (OBLIGATORIO, NUNCA Fresia, puede ser nombre de persona f√≠sica)\",\n  \"supplierTaxId\": \"string o null (CIF/NIF del proveedor normalizado, SIN espacios/guiones/puntos, NO B87392700)\",\n  \"issueDate\": \"YYYY-MM-DD (SIEMPRE formato ISO, convertir desde espa√±ol si es necesario)\",\n  \"dueDate\": \"YYYY-MM-DD o null\",\n  \"totalAmount\": number (decimal con punto, ej: 816.00),\n  \"taxAmount\": number o null (IVA, decimal con punto, ej: 168.00),\n  \"taxRate\": number o null (porcentaje de IVA, ej: 21),\n  \"irpfAmount\": number o null (retenci√≥n IRPF, decimal con punto, ej: 152.00),\n  \"irpfRate\": number o null (porcentaje de IRPF, ej: 19),\n  \"subtotalAmount\": number o null (base imponible, decimal con punto, ej: 800.00),\n  \"currency\": \"EUR\",\n  \"lines\": [{\"lineNumber\": 1, \"description\": \"string\", \"quantity\": number, \"unitPrice\": number, \"taxRate\": number, \"lineTotal\": number}]\n}\n\nREGLAS FINALES:\n- supplierName es OBLIGATORIO y NUNCA puede contener 'Fresia'\n- supplierName puede ser nombre de persona f√≠sica (ej: 'ROMANA S√ÅNCHEZ GIJ√ìN' o 'D¬™ ROMANA S√ÅNCHEZ GIJ√ìN')\n- Si solo ves Fresia como empresa, busca mejor: hay otra empresa en laterales, logo, o texto vertical\n- supplierTaxId debe ser el CIF/NIF del PROVEEDOR normalizado (sin espacios, guiones, puntos)\n- supplierTaxId NUNCA puede ser B87392700 (es de Fresia, el cliente)\n- Si no encuentras el CIF del proveedor, devuelve null (no inventes uno)\n- issueDate SIEMPRE en formato ISO (YYYY-MM-DD), convertir desde espa√±ol completo si es necesario\n- N√∫meros decimales con punto (no comas)\n- invoiceNumber mantener formato original (ej: '12/2022')\n- Solo JSON, sin markdown"
    }
  },
  "InvoiceProcessing": {
    "OcrConfidenceThreshold": 0.85,
    "TotalTolerance": 0.5,
    "ExtractionVersion": "1.0",
    "EnableFallback": true,
    "FallbackMaxShare": 0.15,
    "Classification": {
      "Model": "gpt-4o-mini",
      "MaxTokens": 300,
      "SystemPrompt": "Eres un clasificador contable econ√≥mico. Devuelves solo JSON estricto."
    }
  },
  "WhatsApp": {
    "Enabled": false,
    "PhoneNumberId": "YOUR-WHATSAPP-TOKEN-HERE",
    "AccessToken": "YOUR-WHATSAPP-TOKEN-HERE",
    "RecipientPhone": "+34636176586",
    "SendOnTaskCreation": true,
    "SendDailySummary": false,
    "DailySummaryTime": "09:00"
  }
}

